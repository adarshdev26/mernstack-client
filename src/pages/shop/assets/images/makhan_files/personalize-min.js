var perWidget=!0,called_again=!1,syncDataCalledCnt=0,tier1CityListPersonalize=["Bengaluru","Delhi","Chennai","Hyderabad","Mumbai","Pune","Kolkata","Ahmedabad"],personalizeVer=12,isSyncLSDataComplete=!1;async function initFunc(e){"undefined"!=typeof IMStore&&!0==IMStore.localStorageLoaded?syncDataCheck():e<=10?setTimeout(()=>{initFunc(e+1)},500):syncDataCheck()}async function syncDataCheck(){syncDataCalledCnt+=1;let e=0,t="",a="na",r="",i=1,n=new Date().getTime();if("undefined"!=typeof sugg&&sugg&&"function"==typeof sugg.recent){let c=await sugg.recent("meta_data")||[],l=document.cookie;l.includes("ImeshVisitor")&&l.includes("glid%3D")&&(a=getDataFromCookies(1),i=2),l.includes("im_iss=")&&!l.includes("im_iss=;")&&(t=getDataFromCookies(3),i=3),r=getDataFromCookies(2);let s=c.length>0?c[c.length-1]:null,d=s?.p_gid||"na",o=s?.p_vid||"",m=s?.m_time,u=s?.m||-1,f=n-m>6e5||d!=a||i!=u;"na"!=d&&d!=a&&(e=1);let y=!1;(i<u||1==e)&&(["prod_data","mcat_data","keyw_data"].forEach(deleteImsKey),y=!0),0===c.length||f?(sugg.recent({meta_data:[{m_time:m,p_gid:a,p_vid:r,m:i}]}),await updateImsData(a,r,e,t,i,u,y)):"na"==d&&sugg.recent({meta_data:[{m_time:m,p_gid:d,p_vid:o,m:u}]})}else syncDataCalledCnt<5&&setTimeout(syncDataCheck,400);isSyncLSDataComplete=!0}function getDataFromCookies(e){let t,a=document.cookie||"";if(1==e){let r=a.match(/(glid%3D)[0-9]+/g);t=r?r[0].replace("glid%3D",""):void 0}else if(2==e){let i=a.match(/(_ga=GA1.2.)([0-9]+).([0-9]+)/g);t=i?i[0].replace("_ga=",""):void 0}else if(3==e){let n=a.match(/im_iss=t%3D[^( |;)]+/g);t=n?n[0].replace("im_iss=t%3D",""):void 0}else if(4==e){let c=a.match(/(dispid)[0-9]+/g);t=(t=c?c.toString():"")?t.replace(/dispid/g,""):""}return t}function deleteImsKey(e){"undefined"!=typeof asgv&&void 0!==asgv.store.setData&&asgv.store.setData("ims",e,[])}async function updateImsData(e,t,a,r,i,n,c){let l=window.location.hostname,s=l.includes("dev")||l.includes("stg")?"dev-":"",d=`https://${s}apps.imimg.com/index.php?r=Related/GetAttributes/&modid=MY&mode=${i}`,o,m=t&&"na"!==t,u=e&&"na"!==e,f=new Date().getTime();if(1==i&&m?o=d+`&gid=${t}&t=${f}`:2==i&&u&&m?o=d+`&glusrId=${e}&gid=${t}&t=${f}`:3==i&&u&&r&&"na"!==r&&(o=d+`&glusrId=${e}&AK=${r}&t=${f}`),o)try{let y=new AbortController,g=y.signal,p=setTimeout(()=>{y.abort()},3e3),h=await fetch(o,{method:"GET",signal:g});clearTimeout(p);let C=await h.json(),{code:E,categories:A=[],product:D=[],searches:I=[]}=C,T=[{m_time:new Date().getTime(),p_gid:e,p_vid:t,m:i}];function P(e){return e.sort((e,t)=>t.DT-e.DT),filterUniqueByKeys(e,"id")}async function M(e,t){(arr=P(t).slice(0,25)).length>0?await sugg.recent({[e]:arr}):deleteImsKey(e)}async function v(e,t,a){let r=a.concat(e);(r=P(r).slice(0,25))&&r.length>0?(r[0].type_update="s",await sugg.recent({[t]:r})):deleteImsKey(t)}async function _(e){Object.keys(e).forEach(async t=>{let a=await sugg.recent(`${t}`)||[];c&&(a=[]),200==E&&e[t]?.length>0?await v(e[t]||[],t,a):await M(t,a)})}sugg.recent({meta_data:T}),_({mcat_data:A,prod_data:D,keyw_data:I})}catch(w){console.log("Error: ",w),sendErrEvent("err",w,"updateImsData: ")}}function sendEvent(e,t,a,r){"undefined"!=typeof imgtm&&imgtm.push({event:"IMEvent-NI",eventCategory:e||"pers_log",eventAction:t||"",eventLabel:a||window.location.href,eventValue:r||""})}function sendErrEvent(e,t,a=""){sendEvent("err"===e?"pers_err":"pers_log",a+t.message,window.location.href,t.stack)}function trim_prod(e){let t=e.img_250||e.img_125||"";return""!=(t=(t=t.replace("http:","https:")).match(/(.*)default-image\/add-image.gif(.*)/)?"":t)&&""!=e.name}function trim_mcats(e){return(e.img_125||e.img_250||"")&&e.fl_name}function filterUniqueByKeys(e,t,a=""){let r=new Set;return e.filter(e=>{let i=String(e[t]),n=String(e[a]),c=a?`${i}_${n}`:i;return!r.has(c)&&r.add(c)})}function fetchUserCity(){let e="";try{let t=sessionStorage.getItem("minidtlsres")||"";if(t){let a=JSON.parse(t),r=Object.keys(a)[0],i=a[r]?.Response?.Data;i&&(e=i.user_city||"")}}catch(n){console.log("Error: ",n),sendErrEvent("err",n,"fetchUserCity: ")}return e}async function CheckSuggester(e){if("undefined"==typeof sugg||""==sugg||"function"!=typeof sugg.recent)return Promise.resolve();for(let t=0;t<10&&(!IMStore.localStorageLoaded||!isSyncLSDataComplete);t++)9===t&&sendEvent("pers_error","Exceeded retry limit for waiting for local storage",window.location.href,IMStore.localStorageLoaded),await new Promise(e=>setTimeout(e,500));try{let a=await e();return a}catch(r){return sendErrEvent("err",r,"CheckSuggester: "),[]}}!async function(){try{"complete"==document.readyState?setTimeout(()=>initFunc(1),200):$(window).load(function(){setTimeout(()=>initFunc(1),200)})}catch(e){console.log("Personalize.js error: ",e),sendErrEvent("err",e,"Global: ")}}();const keyMapProd={id:"DISPLAY_ID",img_250:"IMAGE_250X250",name:"ITEM_NAME",c_name:"COMPANYNAME",mcatid:"MCAT_ID",price_f:"PRICE_F",price:"PRICE",unit:"PRD_SEARCH_MOQ_UNIT_TYPE",currency:"CURRENCY",c_url:"COMPANY_URL",d_flag:"IIL_DISPLAY_FLAG",iil_display_flag:"IIL_DISPLAY_FLAG",s_id:"GLUSR_ID",c_number:"CONTACT_NUMBER",c_w:"CUSTTYPE_WEIGHT",city:"CITY_NAME",img_125:"IMAGE_125X125",state:"STATE_NAME",v_url:"PROD_VIDEO_PATH",district:"DIST_NAME",tscode:"ETO_OFR_COMPANY_TSCODE",locality:"SDA_GLUSR_USR_LOCALITY",prod_url:"PDP_URL"},keyMapCatg={id:"GLCAT_MCAT_ID",img_125:"GLCAT_MCAT_IMG1_125X125",img_250:"GLCAT_MCAT_IMG1_250X250",name:"GLCAT_MCAT_NAME",fl_name:"GLCAT_MCAT_FLNAME",city:"",cityflname:""};function mapKeys(e,t){let a={};for(let[r,i]of Object.entries(t))a[r]=e[i]||"";return a}async function fetchPersProds(e){let t=e.count||0,a=e.modid||"",r=e.displayID||"",i=e.callRelatedAPI||!1,n=[],c=[],l=async()=>{c=await sugg.recent("mcat_data")||[],n=filterUniqueByKeys(n=await sugg.recent("prod_data")||[],"id").filter(trim_prod),c=filterUniqueByKeys(c,"id"),r&&(n=n.filter(e=>e&&e.id!=r));let e=n.length;try{if(t>e&&i){let[l,s]=await relatedApiFunc({req_count:t-e,modid:a,datatyp:"P",mcat_arr:c.slice(0,3).map(e=>e.id)||[]});if(!s&&l.length>0){let d=l.map(e=>mapKeys(e,keyMapProd));n.push(...d),n=filterUniqueByKeys(n,"id")}}}catch(o){console.error("Error: ",o),sendErrEvent("err",o,"fetchPersProds relatedAPI: ")}return n};try{let s=await CheckSuggester(l);return s=s.slice(0,t)}catch(d){return console.error("Error in fetchFeaturedRecom: ",d),sendErrEvent("err",d,"fetchPersProds: "),[]}}async function fetchPersCatg(e){let t=e.count||0,a=e.modid||"",r=e.mcatID||"",i=e.callRelatedAPI||!1,n=[],c=async()=>{n=filterUniqueByKeys(n=await sugg.recent("mcat_data")||[],"id").filter(trim_mcats),r&&(n=n.filter(e=>e&&e.id!=r));let e=n.length;try{if(t>e&&i){let[c,l]=await relatedApiFunc({req_count:t-e,modid:a,datatyp:"M",mcat_arr:n.slice(0,3).map(e=>e.id)||[]});if(!l&&c.length>0){let s=c.map(e=>mapKeys(e,keyMapCatg));n.push(...s),n=filterUniqueByKeys(n,"id")}}}catch(d){console.error("Error: ",d),sendErrEvent("err",d,"fetchPersCatg relatedAPI: ")}let o=fetchUserCity()||"";o=tier1CityListPersonalize.includes(o)?o:"";for(let m=0;m<n.length;m++){o&&void 0!==n[m].cityflname&&!n[m].cityflname&&(n[m].city=o,n[m].cityflname=o.toLowerCase());let u=n[m].cityflname||"impcat";n[m].mcat_url=`https://dir.indiamart.com/${u}/${n[m].fl_name}.html`}return n};try{let l=await CheckSuggester(c);return l=l.slice(0,t)}catch(s){return sendErrEvent("err",s,"fetchPersCatg: "),[]}}async function relatedApiFunc(e){let{req_count:t=0,modid:a,datatyp:r="P",mcat_arr:i=[]}=e,n=window.location.hostname,c=`https://${n.includes("dev")||n.includes("stg")?"dev-":""}apps.imimg.com/index.php?r=Related/RelatedAPIDATA/&count=${t}&Modid=${a}&TYPE=${r}&src=pers`;for(let l=0;l<i.length&&l<3;l++)i[l]&&(c+=`&MCAT_ID${l+1}=${i[l]}`);try{let s=new AbortController,d=s.signal,o=setTimeout(()=>{s.abort()},3e3),m=await fetch(c,{method:"GET",signal:d});clearTimeout(o);let u=await m.json(),f=[];return u?.Status==200&&(f="P"==r?u["RECOMMENDED DATA"]:u["RECOMMENDED MCAT DATA"]),[f,""]}catch(y){return sendErrEvent("err",y,"relatedApiFunc: "),[[],y.message]}}