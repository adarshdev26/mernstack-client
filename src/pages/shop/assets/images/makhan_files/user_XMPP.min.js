var chatCreateGlobal=1,XMPPWS=null,xmppPingInterval=null,CSS_ADD_CHECK=1;setInterval(updateXMPPNotifTime,3e4);var XMPP_POPUP_GLID=[],usr_glid=extractImeshVisitor("glid");function getCookieValue(e){var t=document.cookie.match("(^|;)\\s*"+e+"\\s*=\\s*([^;]+)");return t?t.pop():""}if(document.cookie.indexOf("ImeshVisitor=")>-1&&""!=getCookieValue("ImeshVisitor")&&-1===document.cookie.indexOf("adminiil=")){if("function"==typeof SharedWorker&&"function"==typeof BroadcastChannel){var broadcastChannel=new BroadcastChannel("WebSocketChannel"),sharedWorker=new SharedWorker("/XMPPworker.js?v=2");setTimeout((function(){var e={};""==getCookieValue("im_iss")&&""!=getCookieValue("ImeshVisitor")?(e.sasl=saslAuth(1),e.identifiedMode=1):(e.sasl=saslAuth(),e.identifiedMode=0),broadcastChannel.postMessage(e)}),50),broadcastChannel.onmessage=function(e){try{var t=e.data;if(null!=t.connectionState&&1==t.connectionState){var n={};""==getCookieValue("im_iss")?(n.sasl=saslAuth(1),n.identifiedMode=1):(n.sasl=saslAuth(),n.identifiedMode=0),broadcastChannel.postMessage(n)}if(""!=getCookieValue("im_iss")&&("10359580"==usr_glid||"7349419"==usr_glid||"59063812"==usr_glid||document.getElementsByTagName("body")[0].classList.contains("FCP"))){var i=getXML(t);"message"==i.nodeName&&i.getElementsByTagName("body")[0]&&(XMPPGATrack("XMPP","Chat_msg_recv",""+usr_glid,""),showXMPPmessageNotif(i))}}catch(e){console.log("XMPP Dev Error: "+e)}}}else{function getStanzaType(e){return e.substr(1,e.indexOf(" ")-1)}function initWS(){(XMPPWS=new WebSocket("wss://imchat.indiamart.com/ws","xmpp")).onopen=XMPPinit,XMPPWS.onclose=initWS}function XMPPinit(){XMPPWS.send('<open to="chat.indiamart.com" version="1.0" xmlns="urn:ietf:params:xml:ns:xmpp-framing"/>'),XMPPWS.onmessage=function(e){"stream:features"==getStanzaType(e.data)&&sendAuthStanza(saslAuth())}}function sendAuthStanza(e){XMPPWS.send('<auth mechanism="PLAIN" xmlns="urn:ietf:params:xml:ns:xmpp-sasl">'+e+"</auth>"),XMPPWS.onmessage=function(e){"success"==getStanzaType(e.data)?(XMPPWS.send('<open to="chat.indiamart.com" version="1.0" xmlns="urn:ietf:params:xml:ns:xmpp-framing"/>'),XMPPWS.onmessage=resourceBinding):"failure"==getStanzaType(e.data)&&createNewUser("direct")}}function resourceBinding(e){var t="MY-"+(new Date).getTime();"stream:features"==getStanzaType(e.data)&&(XMPPWS.send('<iq id="_bind_auth_2" type="set" xmlns="jabber:client"><bind xmlns="urn:ietf:params:xml:ns:xmpp-bind"><resource>'+t+"</resource></bind></iq>"),XMPPWS.onmessage=declareAuth)}function declareAuth(e){"iq"==getStanzaType(e.data)&&(XMPPWS.send('<iq id="_session_auth_2" type="set" xmlns="jabber:client"><session xmlns="urn:ietf:params:xml:ns:xmpp-session"/></iq>'),XMPPWS.send('<presence xmlns="jabber:client"><status>Online</status><priority>1</priority></presence>'),XMPPWS.onmessage=broadcastXMLToTabs,xmppPingInterval=setInterval(xmppPing,5e4))}function broadcastXMLToTabs(e){if("presence"==getStanzaType(e.data))try{if(e.data.includes("subscribe")&&!e.data.includes("subscribed")){var t=e.data,n=t.substring(t.indexOf("from")+6);n=n.substring(0,n.indexOf("@")),XMPPWS.send('<presence to="'+n+'@chat.indiamart.com" xmlns="jabber:client" type="subscribed"/>'),XMPPWS.send('<presence to="'+n+'@chat.indiamart.com" xmlns="jabber:client" type="subscribe"/>')}}catch(e){}}function xmppPing(){null!==XMPPWS&&XMPPWS.send('<iq to="chat.indiamart.com" type="get" xmlns="jabber:client"><ping xmlns="urn:xmpp:ping"/></iq>')}initWS()}var webAddressLoc=location.hostname,homeServerName=webAddressLoc.match(/^dev/)?"//dev-utils.imimg.com/":webAddressLoc.match(/^stg/)?"//stg-utils.imimg.com/":"//utils.imimg.com/";function XMPPReply(e,t,n,i){var s=document.getElementById(`XMPPText${n}`).value.trim();if(0!=s.length){document.getElementById(`XMPPText${n}`).value="",e=e||1,t=t||"C";var a={type:"sendReply",subject:"Message Centre",msg:s=s.replace(/\u200B/g,""),qid:e,recv_id:n,IIL_RFQ_SOURCE_ID:"27",qtype:t,glid:i,contact_year:"2022",modid:"DIR",AK:getCookieValue("im_iss").substr(4),dir_query_reply_template_flag:5};$.ajax({url:"/"+homeServerName+"header/scripts/head_services.php",data:a,dataType:"json",type:"GET",success:function(e){try{var t="";t=document.getElementById("glusr_fl_name")?document.getElementById("glusr_fl_name").value:document.getElementsByClassName("Hd_dib Hd_pr")[0].innerText;readCookie("ImeshVisitor");displayXMPPMessage(n,t,s.replace(/\bhttps?:\/\/\S+/gi,'<a href="$&" target="_blank" rel="nofollow" style="color: blue">$&</a>'));var i=null!=e.UNIQUE_MSG_ID&&""!=e.UNIQUE_MSG_ID?e.UNIQUE_MSG_ID:"";sendXMPPMessage(a,i)}catch(e){console.log(e)}},error:function(e){}})}}function stripHtml_xmpp(e){return e.replace(/<strong>/g," ").replace(/<strong\/>/g," ").replace(/<\/strong>/g," ").replace(/<br>/g,"\n").replace(/<br\/>/g,"\n").replace(/<\/br>/g,"\n")}function displayXMPPMessage(e,t,n){var i=(new Date).getTime();document.getElementById(`XMPPdiv${e}`).innerHTML+=`\n            <span style="margin-bottom:5px;display:block"><b>${t}</b> <br> <span style="color:#999" class="XMPP_Time" value=${i}>Now</span></span>\n            <div class="xmpp_chat">${n}</div>\n        `,document.getElementById(`XMPPdiv${e}`).scrollTop=document.getElementById(`XMPPdiv${e}`).scrollHeight,showXMPPPopup(e)}function createXMPPChatPopup(e,t,n,i,s,a){var o=(new Date).getTime(),r=document.createElement("div");r.setAttribute("id",`XMPP_message_container${e}`),r.setAttribute("class","XMPP_message_container"),r.value=e,r.innerHTML=`\n                <div class="xmpp_hdr" onclick="toggleXMPPNotif(${e})">\n                <svg width="16" height="16" viewBox="0 0 16 16" fill="none" style="position: absolute;right: 32px;top: 13px;"><rect width="16" height="16" fill="none"></rect><rect x="4" y="11" width="8" height="2" fill="#ddd"></rect></svg>\n                <svg onclick="event.stopPropagation();closeXMPPPopup('${e}');" xmlns="http://www.w3.org/2000/svg" x="0px" y="0px" width="15" height="15" viewBox="0 0 16 16" style="fill: #fff;margin-top: 1px;cursor:pointer;position: absolute;right: 11px;top: 13px;"><g><path style=" " d="M 2.75 2.042969 L 2.042969 2.75 L 2.398438 3.101563 L 7.292969 8 L 2.042969 13.25 L 2.75 13.957031 L 8 8.707031 L 12.894531 13.605469 L 13.25 13.957031 L 13.957031 13.25 L 13.605469 12.894531 L 8.707031 8 L 13.957031 2.75 L 13.25 2.042969 L 8 7.292969 L 3.101563 2.398438 Z "></path></g></svg>\n                <span class="onlinegrn"></span>\n                <span class="client_nme" title="Message from ${t}">${t}</span>\n                </div>\n                <span class="XMPPdiv" id="XMPPdiv${e}">\n                <span style="margin-bottom:5px;display:block"><b>${t}</b> <br> <span style="color:#999" class="XMPP_Time" value=${o}>Now</span></span>\n                <div class="xmpp_chat">${n}</div>\n                </span>\n                <div style="float: left;margin: 20px;position: relative;" id="XMPP_Notif_Footer${e}">\n                <textarea id="XMPPText${e}" placeholder="Type your Message..." class="xmpp_txtarea"></textarea>\n                <div style="box-sizing: border-box;" onclick="XMPPReply('${s}','${a}','${e}','${i}')" class="xmpp_rply_icn">\n                <svg width="14" height="14" viewBox="0 0 14 14" fill="none" style="margin-top:1px; margin-left: 3px; float: left;" xmlns="http://www.w3.org/2000/svg">\n                <path d="M14 0L0 7.87499L4.47413 9.53207L11.375 3.0625L6.12598 10.1439L6.13025 10.1455L6.12502 10.1439V14L8.63409 11.0728L11.8125 12.25L14 0Z" fill="white"></path>\n                </svg>\n                </div>\n                </div>\n                </div>\n        `,document.body.appendChild(r),showXMPPPopup(e),XMPPGATrack("XMPP","Chat_Popup_New",""+i,"")}function showXMPPmessageNotif(e){addXMPPNotifCSS();var t=0;e.getElementsByTagName("sent").length>0&&(t=1,e=e.getElementsByTagName("message")[0]);var n=e.getElementsByTagName("body")[0],i=JSON.parse(n.innerHTML),s=i.msg_text,a=i.msg_sender_name;if(null!=a&&""!==a){i.msg_sender_contact_number;var o=i.msg_sender_id,r=i.msg_query_id,l=i.msg_query_type,d=extractImeshVisitor("glid"),c=document.getElementById(`XMPP_message_container${o}`);(new Date).getTime();if(1!=t){try{var m=document.getElementById("xmppNotif");m||((m=document.createElement("audio")).setAttribute("id","xmppNotif"),m.innerHTML='<source src="https://seller.imimg.com/audios/Xmpp_notif.mp3" type="audio/mpeg">',document.body.appendChild(m)),m.play()}catch(e){}c?displayXMPPMessage(o,a,s):createXMPPChatPopup(o,a,s,d,r,l)}else{var p=i.msg_receiver_id;(c=document.getElementById(`XMPP_message_container${p}`))&&displayXMPPMessage(p,a,s)}}}function addXMPPNotifCSS(){if(0!=CSS_ADD_CHECK){CSS_ADD_CHECK=0;var e="\n        .XMPP_message_container{border-radius: 3px 3px 0 0;box-shadow: 0px 4px 30px 0px #00000024;position: fixed;bottom: 0;width: 300px;max-height: 400px;z-index: 9;background: #fff;right: 20px;min-height: 120px;}\n        .XMPPdiv::-webkit-scrollbar {width: 5px;}\n        .XMPPdiv::-webkit-scrollbar-track {box-shadow: inset 0 0 5px grey;border-radius: 10px;}\n        .XMPPdiv::-webkit-scrollbar-thumb {background: #757575;border-radius: 10px;}\n        .xmpp_hdr{cursor:pointer; border-radius:3px 3px 5px 5px;height: 40px;background: #2E3192;width:100%;color: #fff;font-size: 14px;padding: 13px 15px 0 15px;box-sizing: border-box;}\n        .onlinegrn{float: left;margin: 2px;border:1px solid #fff;width:11px;height:11px;background:green;margin-right: 10px;border-radius:50%}\n        .client_nme{float: left;white-space: nowrap;overflow: hidden;text-overflow: ellipsis;width: calc(100% - 70px);height: 20px;}\n        .XMPPdiv{display:block; padding: 10px 15px;font-size: 13px;float: left;overflow-y: scroll;max-height: 290px;width: calc(100% - 0px);line-height: 140%;color:#10283F;font-size:12px;box-sizing: border-box;}\n        .xmpp_dt{padding: 14px 0 5px 0 ; border-top: 1px solid #EAEAEA; min-height: inherit!important; position: relative; margin-top: 14px ;}\n        .xmpp_dt span{border-radius:50px;position: absolute;top: -16px;background: #fff;padding: 5px 10px;left: 50%;margin-left: -26px;border: 1px solid #eaeaea;}\n        .xmpp_chat{width: fit-content; min-width: 50px; background: #efefef;max-width: 100%; text-align: left;border:1px solid #E8EAEB;border-radius:9px;padding:10px;margin-bottom:10px; word-break:break-word; }\n        .xmpp_txtarea{border: 1px solid rgb(204, 204, 204);padding: 8px 15px 0 20px;width: 212px;height: 35px;float: left;resize: none;max-height: 100px;margin: 0px 10px 0px 0px;border-radius: 38px;outline:none; box-sizing: border-box;}\n        .xmpp_rply_icn{background: #00a699;border-radius:50%;cursor: pointer;width: 30px;height: 30px;float: left;padding: 7px 5px 0 4px;margin-top:3px;}\n    \n        ",t=document.head||document.getElementsByTagName("head")[0],n=document.createElement("style");t.appendChild(n),n.type="text/css",n.styleSheet?n.styleSheet.cssText=e:n.appendChild(document.createTextNode(e))}}function hideXMPPPopup(e){document.getElementById(`XMPP_message_container${e}`).style.display="none"}function showXMPPPopup(e,t){if(1==t||!document.getElementById(`XMPP_message_container${e}`)||"block"!=document.getElementById(`XMPP_message_container${e}`).style.display){for(let e=0;e<XMPP_POPUP_GLID.length;e++)hideXMPPPopup(XMPP_POPUP_GLID[e]);-1!=XMPP_POPUP_GLID.indexOf(e)&&XMPP_POPUP_GLID.splice(XMPP_POPUP_GLID.indexOf(e),1),XMPP_POPUP_GLID.push(e);var n=20;for(let e=XMPP_POPUP_GLID.length-3;e<XMPP_POPUP_GLID.length;e++)document.getElementById(`XMPP_message_container${XMPP_POPUP_GLID[e]}`)&&(document.getElementById(`XMPP_message_container${XMPP_POPUP_GLID[e]}`).style.display="block",document.getElementById(`XMPP_message_container${XMPP_POPUP_GLID[e]}`).style.left=n+"px",n=10+n+document.getElementById(`XMPP_message_container${XMPP_POPUP_GLID[e]}`).offsetWidth)}}function toggleXMPPNotif(e){try{"none"==document.getElementById(`XMPPdiv${e}`).style.display?(document.getElementById(`XMPPdiv${e}`).style.display="block",document.getElementById(`XMPP_Notif_Footer${e}`).style.display="block",document.getElementById(`XMPP_message_container${e}`).style.minHeight="120px"):(document.getElementById(`XMPPdiv${e}`).style.display="none",document.getElementById(`XMPP_Notif_Footer${e}`).style.display="none",document.getElementById(`XMPP_message_container${e}`).style.minHeight="0px"),XMPPGATrack("XMPP","Chat_Popup_Toggle",""+e,"")}catch(e){}}function updateXMPPNotifTime(){for(var e=document.getElementsByClassName("XMPP_Time"),t=(new Date).getTime(),n=0;n<e.length;n++){var i=e[n];try{var s=parseInt(i.getAttribute("value")),a=(t-s)/6e4;a<1?a="Now":a>59?a=getXMPPNotifFormatTime(new Date(s)):(a=a.toFixed(),a+="1"==a?" Min":" Mins"),i.innerText=a}catch(e){}}}function getXMPPNotifFormatTime(e){var t=e.getHours(),n=e.getMinutes(),i=t>=12?"PM":"AM";return(t=(t%=12)||12)+":"+(n=n<10?"0"+n:n)+" "+i}function sendXMPPMessage(e,t){var n=e.glid,i=e.recv_id,s=null!=t?t:"",a="";a=document.getElementById("glusr_fl_name")?document.getElementById("glusr_fl_name").value:document.getElementsByClassName("Hd_dib Hd_pr")[0].innerText;var o=readCookie("ImeshVisitor"),r=getparamVal(o,"mb1"),l={msg_alignment:"left",msg_query_id:e.qid,msg_query_type:e.qtype,msg_read_status:"",msg_receiver_id:e.recv_id,msg_ref_type:"REPLY",msg_sender_id:e.glid,msg_text:e.msg,message_id:s,msg_sender_name:a,msg_sender_contact_number:r};try{msg=JSON.stringify(l),msg=stripHtml_xmpp(msg),msg=msg.replace(/\n/g," ")}catch(e){msg=""}var d=document.implementation.createDocument(null,"message"),c=d.documentElement;c.setAttribute("to",i+"@chat.indiamart.com"),c.setAttribute("xmlns","jabber:client"),c.setAttribute("id",s),c.setAttribute("type","chat");var m=d.createElement("body");m.innerHTML=msg,c.appendChild(m);var p=d.createElement("request");p.setAttribute("xmlns","urn:xmpp:receipts"),c.appendChild(p),postToWorker(c),XMPPGATrack("XMPP","Chat_msg_sent",n>i?i+" "+n:n+" "+i,"")}function saslAuth(e){e=null==e?0:e;var t=extractImeshVisitor("glid");let n=t+"@chat.indiamart.com";return n+="\0",n+=t,n+="\0",n+=1==e?decodeURIComponent(getCookieValue("ImeshVisitor")):getCookieValue("im_iss").substr(4),btoa(function(e){var t,n,i="",s=e.length;for(t=0;t<s;t++)(n=e.charCodeAt(t))>=0&&n<=127?i+=e.charAt(t):n>2047?(i+=String.fromCharCode(224|n>>12&15),i+=String.fromCharCode(128|n>>6&63),i+=String.fromCharCode(128|n>>0&63)):(i+=String.fromCharCode(192|n>>6&31),i+=String.fromCharCode(128|n>>0&63));return i}(n))}function closeXMPPPopup(e){-1!=XMPP_POPUP_GLID.indexOf(e)&&XMPP_POPUP_GLID.splice(XMPP_POPUP_GLID.indexOf(e),1),document.getElementById(`XMPP_message_container${e}`).remove(),setTimeout((function(){XMPP_POPUP_GLID.length>0&&showXMPPPopup(XMPP_POPUP_GLID[XMPP_POPUP_GLID.length-1],1)}),100),XMPPGATrack("XMPP","Chat_Popup_Closed",""+e,"")}function createNewUser(e){if(0!=chatCreateGlobal){chatCreateGlobal=0;var t=extractImeshVisitor("glid");$.ajax({url:"/"+homeServerName+"header/scripts/head_services.php",data:{type:"chatCreateUser",glusrid:t,AK:getCookieValue("im_iss").substr(4)},dataType:"json",type:"GET",success:function(t){if("sw"==e){var n={};n.registered=saslAuth(),broadcastChannel.postMessage(n)}else"direct"==e&&sendAuthStanza(saslAuth())},error:function(e){console.log("not getting response")}})}}function getXML(e){return parser=new DOMParser,xmlDoc=parser.parseFromString(e,"text/xml"),xmlDoc.documentElement}function onSubscriptionRequest(e){try{if("subscribe"==e.getAttribute("type")){var t=e.getAttribute("from");if(null==t)return!0;(e=document.implementation.createDocument(null,"presence").documentElement).setAttribute("to",t),e.setAttribute("xmlns","jabber:client"),e.setAttribute("type","subscribed"),postToWorker(e,"subscribed",t),subscribePresence(t,1)}return!0}catch(e){return!0}}function subscribePresence(e,t){if(t=null==t?0:t,"string"==typeof e&&e.indexOf("@")>-1){var n=document.implementation.createDocument(null,"presence").documentElement;n.setAttribute("to",e),n.setAttribute("xmlns","jabber:client"),n.setAttribute("type","subscribe"),postToWorker(n,"subscribe",e,t)}}function postToWorker(e,t,n,i){try{var s={};s.send=(new XMLSerializer).serializeToString(e),null!=t&&(s[t]=n),null!=i&&(s.force=i),broadcastChannel.postMessage(s)}catch(e){}}}function extractImeshVisitor(e){try{var t="";if(document.cookie.indexOf("ImeshVisitor=")>-1){cookies_raw=document.cookie.split("; "),cookies_obj={};for(var n=cookies_raw.length-1;n>=0;n--)cookie_data=cookies_raw[n].split("="),cookies_obj[cookie_data[0]]=cookie_data[1];var i="";try{i=decodeURIComponent(cookies_obj.ImeshVisitor).split("|")}catch(e){i=unescape(cookies_obj.ImeshVisitor).split("|")}for(n=i.length-1;n>=0;n--)if(i[n].indexOf(e+"=")>-1&&""!==i[n].split("=")[1].trim()){t=i[n].split("=")[1];break}}return t}catch(e){return""}}function XMPPGATrack(e,t,n,i){(document.getElementsByTagName("body")[0].classList.contains("FCP")||window.location.hostname.includes("dir"))&&reqFormGATrack(e,t,n,i)}